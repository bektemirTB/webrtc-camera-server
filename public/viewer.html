<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–º–µ—Ä—ã</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #1a1a1a;
      color: white;
    }
    video {
      width: 100%;
      max-width: 640px;
      border: 2px solid #2196F3;
      border-radius: 8px;
      background: black;
    }
    .status {
      margin: 10px 0;
      padding: 10px;
      background: #333;
      border-radius: 5px;
    }
    .connected { color: #4CAF50; }
    .disconnected { color: #f44336; }
    .waiting { color: #FFC107; }
  </style>
</head>
<body>
  <h1>üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–º–µ—Ä—ã</h1>
  <div class="status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
  <video id="remoteVideo" autoplay playsinline></video>
  <div id="log"></div>

  <script>
    const socket = io("https://webrtc-camera-server.onrender.com");
    const roomId = "room1";
    const video = document.getElementById("remoteVideo");
    const statusDiv = document.getElementById("status");
    const logDiv = document.getElementById("log");
    let peer;

    function log(msg) {
      console.log(msg);
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML = `<div style="color: #888; font-size: 12px;">[${time}] ${msg}</div>` + logDiv.innerHTML;
    }

    socket.on("connect", () => {
      log("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É");
      statusDiv.innerHTML = '<span class="connected">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É</span>';
      socket.emit("join-room", { roomId, role: "viewer" });
      log("üì° –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ: " + roomId);
      statusDiv.innerHTML = '<span class="waiting">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã...</span>';
    });

    socket.on("disconnect", () => {
      log("‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
      statusDiv.innerHTML = '<span class="disconnected">‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞</span>';
    });

    socket.on("offer", async ({ offer, target }) => {
      log("üì• Offer –ø–æ–ª—É—á–µ–Ω –æ—Ç –∫–∞–º–µ—Ä—ã");
      
      if (!offer) {
        log("‚ùå –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π offer");
        console.error("‚ùå –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π offer");
        return;
      }

      try {
        // –°–æ–∑–¥–∞—ë–º PeerConnection
        peer = new RTCPeerConnection({
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        });

        // –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–µ–æ —Ç—Ä–µ–∫
        peer.ontrack = e => {
          log("üì∫ –í–∏–¥–µ–æ —Ç—Ä–µ–∫ –ø–æ–ª—É—á–µ–Ω");
          video.srcObject = e.streams[0];
          statusDiv.innerHTML = '<span class="connected">‚úÖ –í–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è</span>';
        };

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
        peer.onicecandidate = e => {
          if (e.candidate) {
            log("üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–∞–º–µ—Ä–µ");
            socket.emit("ice-candidate", { 
              candidate: {
                candidate: e.candidate.candidate,
                sdpMLineIndex: e.candidate.sdpMLineIndex,
                sdpMid: e.candidate.sdpMid
              }, 
              target 
            });
          }
        };

        peer.oniceconnectionstatechange = () => {
          log("üîó ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: " + peer.iceConnectionState);
          if (peer.iceConnectionState === 'failed') {
            log("‚ùå ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å");
            statusDiv.innerHTML = '<span class="disconnected">‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å</span>';
          }
        };

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º remote description
        await peer.setRemoteDescription(new RTCSessionDescription(offer));
        log("‚úÖ Remote description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");

        // –°–æ–∑–¥–∞—ë–º answer
        const answer = await peer.createAnswer();
        await peer.setLocalDescription(answer);
        
        log("üì° Answer —Å–æ–∑–¥–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–∞–º–µ—Ä–µ");
        socket.emit("answer", { 
          answer: {
            type: answer.type,
            sdp: answer.sdp
          }, 
          target 
        });

        statusDiv.innerHTML = '<span class="waiting">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ...</span>';
      } catch (err) {
        log("‚ùå –û—à–∏–±–∫–∞ WebRTC: " + err.message);
        console.error("‚ùå –û—à–∏–±–∫–∞ WebRTC:", err);
        statusDiv.innerHTML = '<span class="disconnected">‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span>';
      }
    });

    // –í–ê–ñ–ù–û: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –æ—Ç –∫–∞–º–µ—Ä—ã
    socket.on("ice-candidate", async ({ candidate, target }) => {
      log("üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –ø–æ–ª—É—á–µ–Ω –æ—Ç –∫–∞–º–µ—Ä—ã");
      
      if (peer && candidate) {
        try {
          await peer.addIceCandidate(new RTCIceCandidate(candidate));
          log("‚úÖ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω");
        } catch (err) {
          log("‚ùå –û—à–∏–±–∫–∞ ICE: " + err.message);
          console.error("–û—à–∏–±–∫–∞ ICE:", err);
        }
      }
    });

    socket.on("camera-disconnected", () => {
      log("‚ùå –ö–∞–º–µ—Ä–∞ –æ—Ç–∫–ª—é—á–∏–ª–∞—Å—å");
      statusDiv.innerHTML = '<span class="disconnected">‚ùå –ö–∞–º–µ—Ä–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞</span>';
      video.srcObject = null;
      if (peer) {
        peer.close();
        peer = null;
      }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–æ–∫–µ—Ç–∞
    socket.on("error", (error) => {
      log("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∫–µ—Ç–∞: " + error);
      console.error("Socket error:", error);
    });
  </script>
</body>
</html>