<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–º–µ—Ä—ã</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <h1>–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–º–µ—Ä—ã</h1>
  <video id="remoteVideo" autoplay playsinline></video>

  <script>
const socket = io("https://webrtc-camera-server.onrender.com");
const roomId = "room1";
const video = document.getElementById("localVideo");
let stream;
const peerConnections = {}; // –•—Ä–∞–Ω–∏–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ viewerId

socket.emit("join-room", { roomId, role: "camera" });

socket.on("viewer-ready", async (viewerId) => {
  console.log("üëÅ –ó—Ä–∏—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è:", viewerId);

  if (!stream) {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    video.srcObject = stream;
  }

  const pc = new RTCPeerConnection();
  stream.getTracks().forEach(track => pc.addTrack(track, stream));

  pc.onicecandidate = e => {
    if (e.candidate) {
      socket.emit("ice-candidate", { candidate: e.candidate, target: viewerId });
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit("offer", { offer, target: viewerId });

  peerConnections[viewerId] = pc;
});

socket.on("answer", async ({ answer, target }) => {
  const pc = peerConnections[target];
  if (pc) await pc.setRemoteDescription(new RTCSessionDescription(answer));
});

socket.on("ice-candidate", async ({ candidate, target }) => {
  const pc = peerConnections[target];
  if (pc) await pc.addIceCandidate(new RTCIceCandidate(candidate));
});

socket.on("camera-stop", () => {
  console.log("üõë –ó—Ä–∏—Ç–µ–ª–µ–π –Ω–µ—Ç ‚Äî –∫–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è");
  for (const id in peerConnections) {
    peerConnections[id].close();
    delete peerConnections[id];
  }
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    video.srcObject = null;
  }
});
</script>
üîπ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π viewer.html
html
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
<script>
const socket = io("https://webrtc-camera-server.onrender.com");
const roomId = "room1";
const video = document.getElementById("remoteVideo");
let peer;

socket.emit("join-room", { roomId, role: "viewer" });

socket.on("offer", async ({ offer, target }) => {
  console.log("üì° –ü–æ–ª—É—á–µ–Ω offer –æ—Ç –∫–∞–º–µ—Ä—ã");

  peer = new RTCPeerConnection();

  peer.ontrack = e => {
    console.log("üé• –í–∏–¥–µ–æ –ø–æ–ª—É—á–µ–Ω–æ");
    video.srcObject = e.streams[0];
  };

  peer.onicecandidate = e => {
    if (e.candidate) {
      socket.emit("ice-candidate", { candidate: e.candidate, target });
    }
  };

  await peer.setRemoteDescription(new RTCSessionDescription(offer));
  const answer = await peer.createAnswer();
  await peer.setLocalDescription(answer);
  socket.emit("answer", { answer, target });
});

socket.on("camera-disconnected", () => {
  console.log("‚ùå –ö–∞–º–µ—Ä–∞ –æ—Ç–∫–ª—é—á–∏–ª–∞—Å—å");
  video.srcObject = null;
});
</script>
</body>
</html>
