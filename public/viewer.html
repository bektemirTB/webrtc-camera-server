<!-- viewer.html: исправления -->
<!--
  - Сохраняется deviceId зрителя через localStorage, восстанавливает пару и автоматически запускает видео если есть пара
  - Отправка звука от зрителя, включение/выключение камеры по появлению зрителя
-->

<html>
<head>
  <title>Просмотр камеры</title>
  <meta charset="UTF-8">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div id="status"></div>
<div id="pairInfo"></div>
<div id="inputCodeArea"></div>
<video id="viewerVideo" autoplay playsinline></video>
<audio id="localAudio" controls style="display:none"></audio>
<button id="leaveBtn" style="display:none">Выйти</button>
<script>
const role = "viewer";
let deviceId = localStorage.getItem('viewerDeviceId');
if (!deviceId) {
  deviceId = 'view-' + Math.random().toString(36).substr(2, 10);
  localStorage.setItem('viewerDeviceId', deviceId);
}
const socket = io();
socket.emit('register-device', { deviceId, role });

let pairedWith = null;
function showStatus(msg) { document.getElementById('status').innerText = msg; }

socket.on('pair-exists', ({pairedWith:pw, partnerOnline}) => {
  pairedWith = pw;
  showStatus('Пара найдена: ' + pw + (partnerOnline ? ' (онлайн)' : ' (офлайн)'));
  document.getElementById('inputCodeArea').innerText = '';
  document.getElementById('leaveBtn').style.display = 'block';
  if(partnerOnline) startViewer();
});

socket.on('no-pair', () => { 
  document.getElementById('leaveBtn').style.display = 'none';
  pairedWith = null; showStatus('Пары нет.'); document.getElementById('inputCodeArea').innerHTML = '<input id="codeInput" placeholder="Код"> <button id="connectBtn">Подключиться</button>';
  document.getElementById('connectBtn').onclick = () => { const code = document.getElementById('codeInput').value; if(code) socket.emit('connect-with-code', {code, deviceId}); }; 
});

socket.on('paired', ({pairedWith:pw,role}) => {
  pairedWith = pw; showStatus('Связано с камерой: ' + pw);
  document.getElementById('leaveBtn').style.display = 'block';
  document.getElementById('inputCodeArea').innerText = '';
  startViewer();
});

socket.on('pair-broken', () => { pairedWith = null; showStatus('Пара разорвана'); document.getElementById('leaveBtn').style.display = 'none'; });

document.getElementById('leaveBtn').onclick = () => {
  socket.emit('break-pair', {deviceId});
};

// WebRTC: получение видео + отправка аудио
let pc, localStream;
async function startViewer() {
  showStatus('Подключение к камере...');
  localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  document.getElementById('localAudio').srcObject = localStream;
  document.getElementById('localAudio').style.display='block';
  document.getElementById('localAudio').play();

  pc = new RTCPeerConnection();
  localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));
  pc.onicecandidate = e => { if(e.candidate) socket.emit('ice-candidate',{candidate:e.candidate,targetDeviceId:pairedWith}); };
  pc.ontrack = ev => {
    if(ev.track.kind==="video") {
      const video = document.getElementById('viewerVideo');
      video.srcObject = ev.streams[0];
      video.play();
    }
  };
  socket.on('offer', async ({offer,fromDeviceId}) => {
    if(pc && fromDeviceId === pairedWith) {
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
      socket.emit('answer', {answer, targetDeviceId:pairedWith});
    }
  });
  socket.on('ice-candidate', async ({candidate,fromDeviceId}) => {
    if(pc && fromDeviceId === pairedWith) { await pc.addIceCandidate(new RTCIceCandidate(candidate)); }
  });
}
window.addEventListener('focus',()=>{ if(pairedWith) socket.emit('viewer-return', {deviceId}); });
window.addEventListener('blur',()=>{ if(pairedWith) socket.emit('viewer-leave', {deviceId}); });
</script>
</body>
</html>
