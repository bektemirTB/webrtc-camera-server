<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–º–µ—Ä—ã</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#2196F3">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white; margin: 0; }
    .screen { max-width: 600px; margin: 0 auto; }
    .hidden { display: none; }
    .code-input { text-align: center; margin: 2rem 0; }
    .code-input input {
      font-size: 2.5rem; font-weight: bold; padding: 1rem 2rem; background: #333; border: 2px solid #2196F3; border-radius: 12px;
      color: white; text-align: center; letter-spacing: 0.5rem; font-family: 'Courier New', monospace; width: 100%; max-width: 300px;
    }
    .paired-info { background: #1a3a52; padding: 1.5rem; border-radius: 8px; margin: 1rem 0; border: 2px solid #2196F3; }
    .paired-info h3 { margin: 0 0 1rem 0; color: #2196F3; }
    video { width: 100%; min-height: 240px; border: 2px solid #2196F3; border-radius: 8px; background: black; display: block; }
    .status { margin: 10px 0; padding: 10px; background: #333; border-radius: 5px; }
    .connected { color: #4CAF50; } .disconnected { color: #f44336; } .waiting { color: #FFC107; }
    button { padding: 1rem 2rem; font-size: 1.1rem; border: none; border-radius: 8px; cursor: pointer; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; font-weight: 600; width: 100%; margin: 0.5rem 0; }
    button.secondary { background: linear-gradient(135deg, #666, #555); }
    button.danger { background: linear-gradient(135deg, #f44336, #d32f2f); }
    .voice-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0; }
    .mic-button.active { background: linear-gradient(135deg, #f44336, #d32f2f); animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    #log { max-height: 200px; overflow-y: auto; background: #222; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 11px; }
  </style>
</head>
<body>
  <div id="checkScreen" class="screen">
    <h1>üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä –ö–∞–º–µ—Ä—ã</h1>
    <div class="instructions">
      <h3>–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
      <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –ø–∞—Ä—É...</p>
    </div>
  </div>

  <div id="codeScreen" class="screen hidden">
    <h1>üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä –ö–∞–º–µ—Ä—ã</h1>
    <div class="instructions">
      <h3>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
      <p>–ü–æ–ª—É—á–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –æ—Ç –∫–∞–º–µ—Ä—ã. –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 5 –º–∏–Ω—É—Ç.</p>
    </div>
    <div class="code-input">
      <input type="text" id="codeInput" maxlength="4" placeholder="0000" pattern="[0-9]*" inputmode="numeric" />
    </div>
    <button onclick="connectWithCode()" id="connectBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  </div>

  <div id="viewerScreen" class="screen hidden">
    <h1>üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–º–µ—Ä—ã</h1>
    <div class="paired-info">
      <h3>‚úÖ –ü–∞—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞</h3>
      <p><strong>ID –∫–∞–º–µ—Ä—ã:</strong> <span id="pairId" style="font-family: monospace;">---</span></p>
      <!-- –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤–Ω–∏–∑, —Ç—É—Ç –æ—Å—Ç–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ -->
    </div>

    <div class="status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

    <video id="remoteVideo" autoplay playsinline muted></video>
    <audio id="remoteAudio" autoplay></audio>

    <div class="voice-controls">
      <button id="micButton" class="mic-button" onclick="toggleMicrophone()">
        üé§ –ì–æ–≤–æ—Ä–∏—Ç—å
      </button>
      <button onclick="toggleMute()">
        <span id="muteIcon">üîä</span> <span id="muteText">–ó–≤—É–∫</span>
      </button>
    </div>

    <div style="margin-top: 1rem;">
      <button class="secondary" onclick="disconnect()">‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </div>

    <div style="margin-top: 1rem;">
      <button class="danger break-button">üíî –†–∞–∑–æ—Ä–≤–∞—Ç—å –ø–∞—Ä—É</button>
    </div>

    <div id="log"></div>
  </div>

  <script>
    const socket = io("/", { transports: ['websocket', 'polling'] });

    const checkScreen = document.getElementById("checkScreen");
    const codeScreen = document.getElementById("codeScreen");
    const viewerScreen = document.getElementById("viewerScreen");
    const codeInput = document.getElementById("codeInput");
    const video = document.getElementById("remoteVideo");
    const remoteAudio = document.getElementById("remoteAudio");
    const statusDiv = document.getElementById("status");
    const logDiv = document.getElementById("log");
    const pairIdSpan = document.getElementById("pairId");
    const micButton = document.getElementById("micButton");
    const muteIcon = document.getElementById("muteIcon");
    const muteText = document.getElementById("muteText");
    const breakButton = document.querySelector(".break-button");

    let peerConnection;
    let localStream;
    let pairedWith = null;
    let roomId = null;
    let isMicActive = false;

    function log(msg) {
      console.log(msg);
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML = `<div style="color: #888;">[${time}] ${msg}</div>` + logDiv.innerHTML;
    }

    function loadSavedPair() {
      const saved = localStorage.getItem('viewerPair');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          pairedWith = data.pairedWith;
          log("üíæ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –ø–∞—Ä–∞: " + pairedWith);
          return true;
        } catch (e) {
          localStorage.removeItem('viewerPair');
        }
      }
      return false;
    }

    function savePair(cameraId) {
      localStorage.setItem('viewerPair', JSON.stringify({
        pairedWith: cameraId,
        createdAt: Date.now()
      }));
      log("üíæ –ü–∞—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
    }

    function clearPair() {
      localStorage.removeItem('viewerPair');
      pairedWith = null;
      roomId = null;
      log("üóë –ü–∞—Ä–∞ —É–¥–∞–ª–µ–Ω–∞");
    }

    socket.on("connect", () => {
      log("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É: " + socket.id);

      if (loadSavedPair()) {
        log("üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...");
        socket.emit("restore-connection", { pairedWith });
      } else {
        log("üìù –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –ø–∞—Ä—ã");
        showCodeScreen();
      }
    });

    function showCodeScreen() {
      checkScreen.classList.add('hidden');
      codeScreen.classList.remove('hidden');
    }

    codeInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });

    codeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && codeInput.value.length === 4) {
        connectWithCode();
      }
    });

    function connectWithCode() {
      const code = codeInput.value.trim();
      if (code.length !== 4) {
        alert("–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥");
        return;
      }
      log("üîë –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –∫–æ–¥–æ–º: " + code);
      socket.emit("connect-with-code", { code });
      statusDiv.innerHTML = '<span class="waiting">‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—ã...</span>';
    }

    // control break button: confirm + hold 1s
    breakButton.addEventListener("click", () => {
      if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–æ—Ä–≤–∞—Ç—å –ø–∞—Ä—É? –ü—Ä–∏–¥–µ—Ç—Å—è –≤–≤–æ–¥–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥ –æ—Ç –∫–∞–º–µ—Ä—ã.")) {
        socket.emit("break-pair");
      }
    });
    // hold-to-break
    let holdTimer;
    breakButton.addEventListener("mousedown", () => {
      holdTimer = setTimeout(() => socket.emit("break-pair"), 1000);
    });
    breakButton.addEventListener("mouseup", () => { clearTimeout(holdTimer); });
    breakButton.addEventListener("touchstart", () => { holdTimer = setTimeout(() => socket.emit("break-pair"), 1000); });
    breakButton.addEventListener("touchend", () => { clearTimeout(holdTimer); });

    async function toggleMicrophone() {
      if (!isMicActive) {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true
            }
          });

          // attach tracks to peerConnection senders
          if (peerConnection) {
            for (const track of localStream.getAudioTracks()) {
              peerConnection.addTrack(track, localStream);
            }
            // renegotiate
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit("offer", {
              offer: { type: offer.type, sdp: offer.sdp },
              target: pairedWith
            });
          }

          isMicActive = true;
          micButton.classList.add('active');
          micButton.innerHTML = 'üî¥ –ì–æ–≤–æ—Ä—é...';
          log("‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω");
        } catch (err) {
          log("‚ùå –û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: " + err.message);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
        }
      } else {
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          localStream = null;
        }
        isMicActive = false;
        micButton.classList.remove('active');
        micButton.innerHTML = 'üé§ –ì–æ–≤–æ—Ä–∏—Ç—å';
        log("üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω");

        // renegotiate to remove audio senders if needed
        if (peerConnection) {
          try {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit("offer", {
              offer: { type: offer.type, sdp: offer.sdp },
              target: pairedWith
            });
          } catch (e) { log("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–Ω–µ–≥: " + e.message); }
        }
      }
    }

    function toggleMute() {
      // control remote audio element (camera audio)
      if (remoteAudio.muted) {
        remoteAudio.muted = false;
        muteIcon.textContent = 'üîä';
        muteText.textContent = '–ó–≤—É–∫';
      } else {
        remoteAudio.muted = true;
        muteIcon.textContent = 'üîá';
        muteText.textContent = '–ë–µ–∑ –∑–≤—É–∫–∞';
      }
    }

    function disconnect() {
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      video.srcObject = null;
      remoteAudio.srcObject = null;

      viewerScreen.classList.add('hidden');
      checkScreen.classList.remove('hidden');

      isMicActive = false;
      micButton.classList.remove('active');
      micButton.innerHTML = 'üé§ –ì–æ–≤–æ—Ä–∏—Ç—å';

      log("‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ");

      // –Ω–µ –ª–æ–º–∞–µ–º –ø–∞—Ä—É ‚Äî –ø—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ 1 —Å (–ª–æ–∫–∞–ª—å–Ω–æ)
      setTimeout(() => {
        if (loadSavedPair()) {
          socket.emit("restore-connection", { pairedWith });
        } else {
          showCodeScreen();
        }
      }, 1000);
    }

    async function createPeerConnection(targetId) {
      peerConnection = new RTCPeerConnection({
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      });

      peerConnection.ontrack = e => {
        log("üì∫ –¢—Ä–µ–∫ –ø–æ–ª—É—á–µ–Ω: " + e.track.kind);
        // route tracks: video -> video element, audio -> remoteAudio
        if (e.track.kind === 'video') {
          video.srcObject = e.streams[0];
          statusDiv.innerHTML = '<span class="connected">‚úÖ –í–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è</span>';
        }
        if (e.track.kind === 'audio') {
          // play camera audio in remoteAudio element
          remoteAudio.srcObject = e.streams[0];
        }
      };

      peerConnection.onicecandidate = e => {
        if (e.candidate) {
          socket.emit("ice-candidate", {
            candidate: {
              candidate: e.candidate.candidate,
              sdpMLineIndex: e.candidate.sdpMLineIndex,
              sdpMid: e.candidate.sdpMid
            },
            target: targetId
          });
        }
      };

      peerConnection.oniceconnectionstatechange = () => {
        log("üîó ICE: " + peerConnection.iceConnectionState);
        if (peerConnection.iceConnectionState === 'failed') {
          statusDiv.innerHTML = '<span class="disconnected">‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å</span>';
        }
      };
    }

    socket.on("paired", async ({ pairedWith: cameraId, roomId: room }) => {
      pairedWith = cameraId;
      roomId = room;
      savePair(cameraId);

      pairIdSpan.textContent = cameraId.substring(0, 8);

      codeScreen.classList.add('hidden');
      checkScreen.classList.add('hidden');
      viewerScreen.classList.remove('hidden');

      statusDiv.innerHTML = '<span class="connected">‚úÖ –ü–∞—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã...</span>';
      log("‚úÖ –ü–∞—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å: " + cameraId);

      await createPeerConnection(cameraId);
    });

    socket.on("connection-restored", async ({ pairedWith: cameraId, roomId: room }) => {
      pairedWith = cameraId;
      roomId = room;

      pairIdSpan.textContent = cameraId.substring(0, 8);

      checkScreen.classList.add('hidden');
      codeScreen.classList.add('hidden');
      viewerScreen.classList.remove('hidden');

      statusDiv.innerHTML = '<span class="connected">‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</span>';
      log("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å: " + cameraId);

      await createPeerConnection(cameraId);
    });

    socket.on("wait-for-pair", ({ pairedWith: pid }) => {
      // –°–µ—Ä–≤–µ—Ä —Å–∫–∞–∑–∞–ª: –ø–∞—Ä—ã –Ω–µ—Ç, –Ω–æ –∫–ª–∏–µ–Ω—Ç —Ö—Ä–∞–Ω–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –∂–¥–µ–º –≤—Ç–æ—Ä—É—é —Å—Ç–æ—Ä–æ–Ω—É
      pairedWith = pid;
      savePair(pairedWith);
      pairIdSpan.textContent = (pairedWith || '---').substring(0, 8);
      checkScreen.classList.add('hidden');
      codeScreen.classList.add('hidden');
      viewerScreen.classList.remove('hidden');
      statusDiv.innerHTML = '<span class="waiting">‚è≥ –ü–∞—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ. –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–π —Å—Ç–æ—Ä–æ–Ω—ã...</span>';
      log("‚è≥ –ü–∞—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ, –∂–¥–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–π —Å—Ç–æ—Ä–æ–Ω—ã");
    });

    socket.on("partner-online", () => {
      statusDiv.innerHTML = '<span class="connected">‚úÖ –ö–∞–º–µ—Ä–∞ –æ–Ω–ª–∞–π–Ω</span>';
      log("üìπ –ö–∞–º–µ—Ä–∞ –ø–æ–¥–∫–ª—é—á–∏–ª–∞—Å—å");

      // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –µ—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å –ø–∞—Ä–∞
      if (pairedWith) {
        createPeerConnection(pairedWith);
      }
    });

    socket.on("partner-offline", () => {
      statusDiv.innerHTML = '<span class="disconnected">üì¥ –ö–∞–º–µ—Ä–∞ –æ—Ñ–ª–∞–π–Ω</span>';
      log("üì¥ –ö–∞–º–µ—Ä–∞ –æ—Ç–∫–ª—é—á–∏–ª–∞—Å—å");

      // –Ω–µ —Ä–∞–∑—Ä—ã–≤–∞–µ–º –ø–∞—Ä—É ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º PeerConnection –∏ –∂–¥–µ–º
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      video.srcObject = null;
      remoteAudio.srcObject = null;
    });

    socket.on("offer", async ({ offer }) => {
      log("üì• Offer –ø–æ–ª—É—á–µ–Ω");
      if (!peerConnection) {
        await createPeerConnection(pairedWith);
      }
      try {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        socket.emit("answer", {
          answer: { type: answer.type, sdp: answer.sdp },
          target: pairedWith
        });

        log("‚úÖ Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
      } catch (err) {
        log("‚ùå –û—à–∏–±–∫–∞ WebRTC: " + err.message);
      }
    });

    socket.on("ice-candidate", async ({ candidate }) => {
      if (peerConnection && candidate) {
        try {
          await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (err) {
          log("‚ùå –û—à–∏–±–∫–∞ ICE: " + err.message);
        }
      }
    });

    socket.on("pair-broken", () => {
      alert("–ü–∞—Ä–∞ —Ä–∞–∑–æ—Ä–≤–∞–Ω–∞ –∫–∞–º–µ—Ä–æ–π.");
      clearPair();
      // –ø–æ–ª–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ
      if (peerConnection) { peerConnection.close(); peerConnection = null; }
      video.srcObject = null;
      remoteAudio.srcObject = null;
      viewerScreen.classList.add('hidden');
      checkScreen.classList.remove('hidden');
    });

    socket.on("error", (msg) => {
      log("‚ùå –û—à–∏–±–∫–∞: " + msg);
      alert(msg);

      // –µ—Å–ª–∏ –∏—Å—Ç–µ–∫ –∫–æ–¥ ‚Äî –æ—á–∏—â–∞–µ–º –ø–∞—Ä—É
      if (msg.includes("–∏—Å—Ç–µ–∫") || msg.includes("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥") || msg.includes("–≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è")) {
        clearPair();
        if (peerConnection) { peerConnection.close(); peerConnection = null; }
        video.srcObject = null;
        remoteAudio.srcObject = null;
        showCodeScreen();
      }
      // –µ—Å–ª–∏ –ø–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî —Å–µ—Ä–≤–µ—Ä —Ç–µ–ø–µ—Ä—å —à–ª—ë—Ç wait-for-pair –≤–º–µ—Å—Ç–æ error, —Ç–∞–∫ —á—Ç–æ –∑–¥–µ—Å—å –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    });

    video.onloadedmetadata = () => {
      log("üìπ –í–∏–¥–µ–æ: " + video.videoWidth + "x" + video.videoHeight);
    };
  </script>
</body>
</html>
