<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–º–µ—Ä—ã</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#2196F3">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white; margin: 0; }
    .screen { max-width: 600px; margin: 0 auto; }
    .hidden { display: none; }
    .code-input { text-align: center; margin: 2rem 0; }
    .code-input input {
      font-size: 2.5rem; font-weight: bold; padding: 1rem 2rem; background: #333; border: 2px solid #2196F3; border-radius: 12px;
      color: white; text-align: center; letter-spacing: 0.5rem; font-family: 'Courier New', monospace; width: 100%; max-width: 300px;
    }
    .paired-info { background: #1a3a52; padding: 1.5rem; border-radius: 8px; margin: 1rem 0; border: 2px solid #2196F3; }
    .paired-info h3 { margin: 0 0 1rem 0; color: #2196F3; }
    video { width: 100%; min-height: 240px; border: 2px solid #2196F3; border-radius: 8px; background: black; display: block; }
    .status { margin: 10px 0; padding: 10px; background: #333; border-radius: 5px; }
    .connected { color: #4CAF50; } .disconnected { color: #f44336; } .waiting { color: #FFC107; }
    button { padding: 1rem 2rem; font-size: 1.1rem; border: none; border-radius: 8px; cursor: pointer; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; font-weight: 600; width: 100%; margin: 0.5rem 0; }
    button.secondary { background: linear-gradient(135deg, #666, #555); }
    button.danger { background: linear-gradient(135deg, #f44336, #d32f2f); }
    .voice-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0; }
    .mic-button.active { background: linear-gradient(135deg, #f44336, #d32f2f); animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    #log { max-height: 200px; overflow-y: auto; background: #222; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 11px; }
  </style>
</head>
<body>
  <div id="checkScreen" class="screen">
    <h1>üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä –ö–∞–º–µ—Ä—ã</h1>
    <div class="instructions">
      <h3>–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
      <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –ø–∞—Ä—É...</p>
    </div>
  </div>

  <div id="codeScreen" class="screen hidden">
    <h1>üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä –ö–∞–º–µ—Ä—ã</h1>
    <div class="instructions">
      <h3>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
      <p>–ü–æ–ª—É—á–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –æ—Ç –∫–∞–º–µ—Ä—ã. –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 5 –º–∏–Ω—É—Ç.</p>
    </div>
    <div class="code-input">
      <input type="text" id="codeInput" maxlength="4" placeholder="0000" pattern="[0-9]*" inputmode="numeric" />
    </div>
    <button onclick="connectWithCode()" id="connectBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  </div>

  <div id="viewerScreen" class="screen hidden">
    <h1>üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–º–µ—Ä—ã</h1>
    <div class="paired-info">
      <h3>‚úÖ –ü–∞—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞</h3>
      <p><strong>ID –∫–∞–º–µ—Ä—ã:</strong> <span id="pairId" style="font-family: monospace;">---</span></p>
      <!-- –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤–Ω–∏–∑, —Ç—É—Ç –æ—Å—Ç–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ -->
    </div>

    <div class="status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

    <video id="remoteVideo" autoplay playsinline muted></video>
    <audio id="remoteAudio" autoplay></audio>

    <div class="voice-controls">
      <button id="micButton" class="mic-button" onclick="toggleMicrophone()">
        üé§ –ì–æ–≤–æ—Ä–∏—Ç—å
      </button>
      <button onclick="toggleMute()">
        <span id="muteIcon">üîä</span> <span id="muteText">–ó–≤—É–∫</span>
      </button>
    </div>

    <div style="margin-top: 1rem;">
      <button class="secondary" onclick="disconnect()">‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </div>

    <div style="margin-top: 1rem;">
      <button class="danger break-button">üíî –†–∞–∑–æ—Ä–≤–∞—Ç—å –ø–∞—Ä—É</button>
    </div>

    <div id="log"></div>
  </div>

  <script>
const socket = io();
let pc, pairedWith, micStream;

function log(t){console.log("[VIEW]",t)}

function showCode(){ document.getElementById("codebox").style.display="block" }
function showView(){ document.getElementById("view").style.display="block" }

async function createPC(){
  pc = new RTCPeerConnection()
  pc.onicecandidate=e=>{ if(e.candidate) socket.emit("ice-candidate",{candidate:e.candidate,target:pairedWith}) }
  pc.ontrack=e=>{document.getElementById("video").srcObject=e.streams[0]}
}

socket.on("paired",async({pairedWith:id})=>{
  pairedWith=id
  localStorage.setItem("viewerPair",id)
  showView()
  await createPC()
})

socket.on("connection-restored",async({pairedWith:id})=>{
  pairedWith=id
  showView()
  await createPC()
})

socket.on("restore-wait",()=>{
  showView()
})

socket.on("partner-online",async()=>{
  if(!pc) await createPC()
  let offer = await pc.createOffer()
  await pc.setLocalDescription(offer)
  socket.emit("offer",{offer,target:pairedWith})
})

socket.on("offer",async({offer})=>{
  if(!pc) await createPC()
  await pc.setRemoteDescription(offer)
  let ans = await pc.createAnswer()
  await pc.setLocalDescription(ans)
  socket.emit("answer",{answer:ans,target:pairedWith})
})

socket.on("answer",({answer})=>pc.setRemoteDescription(answer))
socket.on("ice-candidate",({candidate})=>pc.addIceCandidate(candidate))
socket.on("pair-broken",()=>{localStorage.removeItem("viewerPair");location.reload()})

document.getElementById("connect").onclick=()=>{
  const code=document.getElementById("pin").value
  socket.emit("connect-with-code",{code})
}

document.getElementById("newpair").onclick=()=>{
  localStorage.removeItem("viewerPair")
  location.reload()
}

document.getElementById("mic").onclick=async()=>{
  if(!micStream){
    micStream=await navigator.mediaDevices.getUserMedia({audio:true})
    micStream.getTracks().forEach(t=>pc.addTrack(t,micStream))
  } else {
    micStream.getTracks().forEach(t=>t.stop())
    micStream=null
  }
}

window.onload=()=>{
  const saved = localStorage.getItem("viewerPair")
  if(saved){
    pairedWith=saved
    socket.emit("restore-connection",{pairedWith:saved})
    showView()
  } else {
    showCode()
  }
}
</script>

</body>
</html>
