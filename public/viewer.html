<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <h1>üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–º–µ—Ä—ã</h1>
  <video id="remoteVideo" autoplay playsinline></video>
  <div id="status">‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

  <script>
    const socket = io("https://webrtc-camera-server.onrender.com");
    const roomId = "main-room";
    const video = document.getElementById("remoteVideo");
    const statusDiv = document.getElementById("status");

    let pc;

    socket.on("connect", () => {
      statusDiv.textContent = "‚úÖ –ó—Ä–∏—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É";
      socket.emit("join-room", { roomId, role: "viewer" });
    });

    socket.on("camera-ready", () => {
      statusDiv.textContent = "üì° –ö–∞–º–µ—Ä–∞ –æ–Ω–ª–∞–π–Ω, –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...";
    });

    socket.on("offer", async (offer) => {
      statusDiv.textContent = "üé• –ü–æ–ª—É—á–µ–Ω –ø–æ—Ç–æ–∫, –∑–∞–≥—Ä—É–∂–∞–µ–º...";
      pc = new RTCPeerConnection();

      pc.ontrack = e => {
        video.srcObject = e.streams[0];
        statusDiv.textContent = "‚úÖ –í–∏–¥–µ–æ –ø–æ–ª—É—á–µ–Ω–æ!";
      };

      pc.onicecandidate = e => {
        if (e.candidate) socket.emit("ice-candidate", { roomId, candidate: e.candidate });
      };

      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit("answer", { roomId, answer });
    });

    socket.on("ice-candidate", async (candidate) => {
      if (pc) await pc.addIceCandidate(new RTCIceCandidate(candidate));
    });

    socket.on("camera-disconnected", () => {
      statusDiv.textContent = "‚ùå –ö–∞–º–µ—Ä–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞";
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
    });
  </script>
</body>
</html>
