<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞–º–µ—Ä–∞</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #1a1a1a;
      color: white;
      margin: 0;
      padding-bottom: 100px;
    }
    .screen {
      max-width: 600px;
      margin: 0 auto;
    }
    .hidden { display: none; }
    
    .pairing-code {
      font-size: 3rem;
      font-weight: bold;
      text-align: center;
      padding: 2rem;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      border-radius: 12px;
      margin: 2rem 0;
      letter-spacing: 0.5rem;
      font-family: 'Courier New', monospace;
    }
    
    .timer {
      font-size: 1rem;
      color: rgba(255,255,255,0.8);
      margin-top: 1rem;
      letter-spacing: normal;
    }
    
    .paired-info {
      background: #2d5016;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1rem 0;
      border: 2px solid #4CAF50;
    }
    
    video {
      width: 100%;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      background: black;
    }
    
    .status {
      margin: 10px 0;
      padding: 10px;
      background: #333;
      border-radius: 5px;
    }
    
    .connected { color: #4CAF50; }
    .disconnected { color: #f44336; }
    .waiting { color: #FFC107; }
    
    .settings {
      background: #333;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    
    .settings label {
      display: block;
      margin: 0.5rem 0;
    }
    
    .settings select {
      padding: 0.5rem;
      background: #444;
      color: white;
      border: 1px solid #555;
      border-radius: 4px;
      width: 100%;
      max-width: 300px;
    }
    
    button {
      padding: 1rem 2rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      font-weight: 600;
      width: 100%;
      margin: 0.5rem 0;
    }
    
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    button.secondary { background: linear-gradient(135deg, #666, #555); }
    button.danger { 
      background: linear-gradient(135deg, #f44336, #d32f2f);
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      max-width: 560px;
      margin: 0 auto;
      z-index: 1000;
    }
    
    #log {
      max-height: 150px;
      overflow-y: auto;
      background: #222;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <!-- –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <div id="setupScreen" class="screen">
    <h1>üìπ –†–µ–∂–∏–º –ö–∞–º–µ—Ä—ã</h1>
    
    <div class="settings">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã</h3>
      
      <label>
        –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ:
        <select id="qualitySelect">
          <option value="sd">SD (640x480)</option>
          <option value="hd" selected>HD (1280x720)</option>
          <option value="fullhd">Full HD (1920x1080)</option>
        </select>
      </label>
      
      <label>
        –í—ã–±–æ—Ä –∫–∞–º–µ—Ä—ã:
        <select id="cameraSelect">
          <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</option>
        </select>
      </label>
      
      <label>
        <input type="checkbox" id="audioToggle" checked> –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
      </label>
    </div>
    
    <button onclick="checkPairAndStart()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
  </div>

  <!-- –≠–∫—Ä–∞–Ω –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞ -->
  <div id="codeScreen" class="screen hidden">
    <h1>üîë –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—ã</h1>
    
    <div class="pairing-code">
      <div id="pairingCode">----</div>
      <div class="timer" id="timer">–û—Å—Ç–∞–ª–æ—Å—å: 5:00</div>
    </div>
    
    <div class="status" id="codeStatus">
      <span class="waiting">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∑—Ä–∏—Ç–µ–ª—è...</span>
    </div>
    
    <p style="text-align: center; color: #999;">
      –ó—Ä–∏—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–≤–µ—Å—Ç–∏ —ç—Ç–æ—Ç –∫–æ–¥ –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç
    </p>
    
    <button class="secondary" onclick="cancelPairing()">‚ùå –û—Ç–º–µ–Ω–∞</button>
  </div>

  <!-- –≠–∫—Ä–∞–Ω —Ä–∞–±–æ—Ç—ã –∫–∞–º–µ—Ä—ã -->
  <div id="cameraScreen" class="screen hidden">
    <h1>üìπ –ö–∞–º–µ—Ä–∞</h1>
    
    <div class="paired-info">
      <h3>‚úÖ –ü–∞—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞</h3>
      <div class="status" id="viewerStatus">
        <span class="disconnected">üì¥ –ó—Ä–∏—Ç–µ–ª—å –æ—Ñ–ª–∞–π–Ω</span>
      </div>
    </div>
    
    <div class="status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
    
    <video id="localVideo" autoplay playsinline muted></video>
    
    <audio id="remoteAudio" autoplay></audio>
    
    <div id="log"></div>
    
    <button class="danger" onclick="confirmBreakPair()">üíî –†–∞–∑–æ—Ä–≤–∞—Ç—å –ø–∞—Ä—É</button>
  </div>

  <script>
    const socket = io("https://webrtc-camera-server.onrender.com", {
      transports: ['websocket', 'polling']
    });
    
    const setupScreen = document.getElementById("setupScreen");
    const codeScreen = document.getElementById("codeScreen");
    const cameraScreen = document.getElementById("cameraScreen");
    const video = document.getElementById("localVideo");
    const remoteAudio = document.getElementById("remoteAudio");
    const statusDiv = document.getElementById("status");
    const viewerStatusDiv = document.getElementById("viewerStatus");
    const codeStatusDiv = document.getElementById("codeStatus");
    const logDiv = document.getElementById("log");
    const pairingCodeDiv = document.getElementById("pairingCode");
    const timerDiv = document.getElementById("timer");
    const qualitySelect = document.getElementById("qualitySelect");
    const cameraSelect = document.getElementById("cameraSelect");
    const audioToggle = document.getElementById("audioToggle");
    
    let stream;
    let peerConnection;
    let pairedWith = null;
    let myOriginalId = null;
    let wakeLock = null;
    let timerInterval = null;
    let codeExpiresAt = null;
    let isViewerOnline = false;

    const qualitySettings = {
      sd: { width: 640, height: 480 },
      hd: { width: 1280, height: 720 },
      fullhd: { width: 1920, height: 1080 }
    };

    function log(msg) {
      console.log(msg);
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML = `<div style="color: #888;">[${time}] ${msg}</div>` + logDiv.innerHTML;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    function getOrCreateOriginalId() {
      let id = localStorage.getItem('cameraOriginalId');
      if (!id) {
        id = 'cam_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        localStorage.setItem('cameraOriginalId', id);
        log("üÜî –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π ID: " + id);
      } else {
        log("üÜî –ó–∞–≥—Ä—É–∂–µ–Ω ID: " + id);
      }
      return id;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –ø–∞—Ä—ã
    function loadSavedPair() {
      const saved = localStorage.getItem('cameraPair');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          pairedWith = data.pairedWith;
          log("üíæ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –ø–∞—Ä–∞: " + pairedWith);
          return true;
        } catch (e) {
          localStorage.removeItem('cameraPair');
        }
      }
      return false;
    }

    function savePair(viewerId) {
      localStorage.setItem('cameraPair', JSON.stringify({
        pairedWith: viewerId,
        createdAt: Date.now()
      }));
      log("üíæ –ü–∞—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
    }

    function clearPair() {
      localStorage.removeItem('cameraPair');
      pairedWith = null;
      log("üóë –ü–∞—Ä–∞ —É–¥–∞–ª–µ–Ω–∞");
    }

    async function checkPairAndStart() {
      await startCamera();
      
      if (loadSavedPair()) {
        log("üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—ã...");
        socket.emit("restore-connection", { originalId: myOriginalId, role: "camera" });
        showCameraScreen();
        viewerStatusDiv.innerHTML = '<span class="waiting">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑—Ä–∏—Ç–µ–ª—è...</span>';
      } else {
        log("üîë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞...");
        socket.emit("generate-code", { originalId: myOriginalId });
        showCodeScreen();
      }
    }

    function showCodeScreen() {
      setupScreen.classList.add('hidden');
      codeScreen.classList.remove('hidden');
    }

    function showCameraScreen() {
      setupScreen.classList.add('hidden');
      codeScreen.classList.add('hidden');
      cameraScreen.classList.remove('hidden');
    }

    function cancelPairing() {
      if (timerInterval) clearInterval(timerInterval);
      stopCamera();
      codeScreen.classList.add('hidden');
      setupScreen.classList.remove('hidden');
    }

    function startTimer(expiresAt) {
      codeExpiresAt = expiresAt;
      
      timerInterval = setInterval(() => {
        const remaining = Math.max(0, codeExpiresAt - Date.now());
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        
        timerDiv.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (remaining <= 0) {
          clearInterval(timerInterval);
          codeStatusDiv.innerHTML = '<span class="disconnected">‚ùå –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ</span>';
        }
      }, 100);
    }

    function confirmBreakPair() {
      if (confirm("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–æ—Ä–≤–∞—Ç—å –ø–∞—Ä—É?\n\n–ü–æ—Å–ª–µ —Ä–∞–∑—Ä—ã–≤–∞ –≤–∞–º –ø—Ä–∏–¥–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥ –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ–º–æ–π –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) {
        socket.emit("break-pair", { originalId: myOriginalId });
      }
    }

    async function loadCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cameras = devices.filter(d => d.kind === 'videoinput');
        
        cameraSelect.innerHTML = '';
        cameras.forEach((camera, index) => {
          const option = document.createElement('option');
          option.value = camera.deviceId;
          option.text = camera.label || `–ö–∞–º–µ—Ä–∞ ${index + 1}`;
          
          if (camera.label.toLowerCase().includes('back')) option.text += ' (–û—Å–Ω–æ–≤–Ω–∞—è)';
          else if (camera.label.toLowerCase().includes('front')) option.text += ' (–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è)';
          else if (camera.label.toLowerCase().includes('wide')) option.text += ' (–®–∏—Ä–æ–∫–æ—É–≥–æ–ª—å–Ω–∞—è)';
          
          cameraSelect.appendChild(option);
        });
        
        log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä: ${cameras.length}`);
      } catch (err) {
        log("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä: " + err.message);
      }
    }

    function getMediaConstraints() {
      const quality = qualitySettings[qualitySelect.value];
      const constraints = {
        video: { 
          width: { ideal: quality.width },
          height: { ideal: quality.height },
          frameRate: { ideal: 30 }
        }, 
        audio: audioToggle.checked ? {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        } : false
      };
      
      if (cameraSelect.value) {
        constraints.video.deviceId = { exact: cameraSelect.value };
      }
      
      return constraints;
    }

    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          log("üîì Wake Lock –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
        }
      } catch (err) {
        log("‚ùå Wake Lock: " + err.message);
      }
    }

    async function startCamera() {
      if (stream) return; // –£–∂–µ –∑–∞–ø—É—â–µ–Ω–∞
      
      try {
        log("üì∑ –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...");
        const constraints = getMediaConstraints();
        
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        log("‚úÖ –ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞");
        
        await requestWakeLock();
        
      } catch (err) {
        log("‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + err.message);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ: " + err.message);
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        video.srcObject = null;
        log("üõë –ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
      }
      
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      
      if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
      }
      
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      cameraScreen.classList.add('hidden');
      codeScreen.classList.add('hidden');
      setupScreen.classList.remove('hidden');
    }

    async function createPeerConnection() {
      if (peerConnection) {
        peerConnection.close();
      }

      peerConnection = new RTCPeerConnection({
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      });

      if (stream) {
        stream.getTracks().forEach(track => {
          peerConnection.addTrack(track, stream);
        });
      }

      peerConnection.ontrack = e => {
        if (e.track.kind === 'audio') {
          remoteAudio.srcObject = e.streams[0];
          log("üîä –ê—É–¥–∏–æ –æ—Ç –∑—Ä–∏—Ç–µ–ª—è");
        }
      };

      peerConnection.onicecandidate = e => {
        if (e.candidate) {
          socket.emit("ice-candidate", { 
            candidate: {
              candidate: e.candidate.candidate,
              sdpMLineIndex: e.candidate.sdpMLineIndex,
              sdpMid: e.candidate.sdpMid
            }, 
            originalId: myOriginalId 
          });
        }
      };

      peerConnection.oniceconnectionstatechange = () => {
        log("üîó ICE: " + peerConnection.iceConnectionState);
        if (peerConnection.iceConnectionState === 'connected') {
          statusDiv.innerHTML = '<span class="connected">‚úÖ –í–∏–¥–µ–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è</span>';
        } else if (peerConnection.iceConnectionState === 'disconnected') {
          statusDiv.innerHTML = '<span class="disconnected">‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ</span>';
        }
      };

      try {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        
        socket.emit("offer", { 
          offer: { type: offer.type, sdp: offer.sdp }, 
          originalId: myOriginalId 
        });
        
        log("‚úÖ Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
      } catch (err) {
        log("‚ùå –û—à–∏–±–∫–∞ offer: " + err.message);
      }
    }

    // Socket —Å–æ–±—ã—Ç–∏—è
    socket.on("connect", () => {
      myOriginalId = getOrCreateOriginalId();
      socket.emit("register", { originalId: myOriginalId, role: "camera" });
      log("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: " + socket.id);
    });

    socket.on("code-generated", ({ code, expiresAt }) => {
      pairingCodeDiv.textContent = code;
      startTimer(expiresAt);
      log("üîë –ö–æ–¥: " + code);
    });

    socket.on("code-expired", () => {
      alert("–í—Ä–µ–º—è –∫–æ–¥–∞ –∏—Å—Ç–µ–∫–ª–æ. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥.");
      cancelPairing();
    });

    socket.on("paired", async ({ pairedWith: viewerId }) => {
      pairedWith = viewerId;
      
      if (timerInterval) clearInterval(timerInterval);
      
      savePair(viewerId);
      
      showCameraScreen();
      viewerStatusDiv.innerHTML = '<span class="connected">‚úÖ –ó—Ä–∏—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω</span>';
      isViewerOnline = true;
      
      log("‚úÖ –ü–∞—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å: " + viewerId);
      
      await createPeerConnection();
    });

    socket.on("connection-restored", async ({ pairedWith: viewerId }) => {
      pairedWith = viewerId;
      log("‚úÖ –ü–∞—Ä–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: " + viewerId);
    });

    socket.on("viewer-online", async () => {
      viewerStatusDiv.innerHTML = '<span class="connected">‚úÖ –ó—Ä–∏—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω</span>';
      isViewerOnline = true;
      log("üëÅ –ó—Ä–∏—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω");
      
      await createPeerConnection();
    });

    socket.on("viewer-offline", () => {
      viewerStatusDiv.innerHTML = '<span class="disconnected">üì¥ –ó—Ä–∏—Ç–µ–ª—å –æ—Ñ–ª–∞–π–Ω</span>';
      isViewerOnline = false;
      statusDiv.innerHTML = '<span class="waiting">‚è∏ –û–∂–∏–¥–∞–Ω–∏–µ –∑—Ä–∏—Ç–µ–ª—è...</span>';
      
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      
      log("üì¥ –ó—Ä–∏—Ç–µ–ª—å –æ—Ñ–ª–∞–π–Ω");
    });

    socket.on("answer", async ({ answer }) => {
      if (peerConnection && answer) {
        try {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
          log("‚úÖ Answer –ø–æ–ª—É—á–µ–Ω");
        } catch (err) {
          log("‚ùå –û—à–∏–±–∫–∞ answer: " + err.message);
        }
      }
    });

    socket.on("ice-candidate", async ({ candidate }) => {
      if (peerConnection && candidate) {
        try {
          await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (err) {
          log("‚ùå ICE: " + err.message);
        }
      }
    });

    socket.on("pair-broken", () => {
      alert("–ü–∞—Ä–∞ —Ä–∞–∑–æ—Ä–≤–∞–Ω–∞.");
      clearPair();
      stopCamera();
    });

    socket.on("error", (msg) => {
      log("‚ùå " + msg);
      if (msg.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω–∞")) {
        clearPair();
        alert(msg + "\n\n–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –ø–∞—Ä—É.");
        stopCamera();
      } else {
        alert(msg);
      }
    });

    loadCameras();
  </script>
</body>
</html>