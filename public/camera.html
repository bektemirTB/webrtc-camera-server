<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞–º–µ—Ä–∞</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #1a1a1a;
      color: white;
    }
    video {
      width: 100%;
      max-width: 640px;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      background: black;
    }
    .status {
      margin: 10px 0;
      padding: 10px;
      background: #333;
      border-radius: 5px;
    }
    .connected { color: #4CAF50; }
    .disconnected { color: #f44336; }
    #log {
      max-height: 300px;
      overflow-y: auto;
      background: #222;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>üìπ –ö–∞–º–µ—Ä–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è</h1>
  <div class="status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
  
  <div style="margin: 10px 0; padding: 10px; background: #333; border-radius: 5px;">
    <label style="margin-right: 10px;">–ö–∞—á–µ—Å—Ç–≤–æ:</label>
    <select id="qualitySelect" style="padding: 5px; background: #444; color: white; border: 1px solid #555; border-radius: 4px;">
      <option value="hd">HD (1280x720)</option>
      <option value="fullhd" selected>Full HD (1920x1080)</option>
      <option value="2k">2K (2560x1440)</option>
      <option value="4k">4K (3840x2160)</option>
    </select>
    <label style="margin-left: 15px; margin-right: 10px;">
      <input type="checkbox" id="audioToggle" checked> –ó–≤—É–∫
    </label>
  </div>
  
  <video id="localVideo" autoplay playsinline muted></video>
  <div id="log"></div>

  <script>
    const socket = io("https://webrtc-camera-server.onrender.com", {
      transports: ['websocket', 'polling']
    });
    const roomId = "room1";
    const video = document.getElementById("localVideo");
    const statusDiv = document.getElementById("status");
    const logDiv = document.getElementById("log");
    let stream;
    const peerConnections = {};
    const iceCandidatesQueues = {}; // –ë—É—Ñ–µ—Ä ICE candidates –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑—Ä–∏—Ç–µ–ª—è
    let wakeLock = null;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Å—ã–ø–∞–Ω–∏—è —ç–∫—Ä–∞–Ω–∞
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          log("üîì Wake Lock –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω - —ç–∫—Ä–∞–Ω –Ω–µ –±—É–¥–µ—Ç –∑–∞—Å—ã–ø–∞—Ç—å");
          
          wakeLock.addEventListener('release', () => {
            log("üîí Wake Lock –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω");
          });
        } else {
          log("‚ö†Ô∏è Wake Lock API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
        }
      } catch (err) {
        log("‚ùå –û—à–∏–±–∫–∞ Wake Lock: " + err.message);
      }
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Wake Lock –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.addEventListener('visibilitychange', async () => {
      if (wakeLock !== null && document.visibilityState === 'visible') {
        await requestWakeLock();
      }
    });

    function log(msg) {
      console.log(msg);
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML = `<div style="color: #888;">[${time}] ${msg}</div>` + logDiv.innerHTML;
    }

    socket.on("connect", () => {
      log("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É, Socket ID: " + socket.id);
      statusDiv.innerHTML = '<span class="connected">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É</span>';
      socket.emit("join-room", { roomId, role: "camera" });
      log("üì° –û—Ç–ø—Ä–∞–≤–ª–µ–Ω join-room —Å —Ä–æ–ª—å—é camera");
    });

    socket.on("disconnect", () => {
      log("‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
      statusDiv.innerHTML = '<span class="disconnected">‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞</span>';
    });

    // –ö–æ–≥–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤—ã–π –∑—Ä–∏—Ç–µ–ª—å
    socket.on("viewer-ready", async (viewerId) => {
      log("üëÅ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ viewer-ready, ID –∑—Ä–∏—Ç–µ–ª—è: " + viewerId);
      statusDiv.innerHTML = '<span class="connected">üëÅ –ó—Ä–∏—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...</span>';

      // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
      if (!stream) {
        try {
          log("üì∑ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...");
          stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              width: { ideal: 1920 },
              height: { ideal: 1080 },
              frameRate: { ideal: 30 }
            }, 
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true
            }
          });
          video.srcObject = stream;
          log("‚úÖ –ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞, —Ç—Ä–µ–∫–æ–≤: " + stream.getTracks().length);
          
          // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º Wake Lock –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
          await requestWakeLock();
        } catch (err) {
          log("‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: " + err.message);
          console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
          return;
        }
      }

      // –°–æ–∑–¥–∞—ë–º PeerConnection –¥–ª—è —ç—Ç–æ–≥–æ –∑—Ä–∏—Ç–µ–ª—è
      const pc = new RTCPeerConnection({
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      });

      // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏
      stream.getTracks().forEach(track => {
        pc.addTrack(track, stream);
        log("‚ûï –¢—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω: " + track.kind);
      });

      // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
      pc.onicecandidate = e => {
        if (e.candidate) {
          log("üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑—Ä–∏—Ç–µ–ª—é " + viewerId);
          socket.emit("ice-candidate", { 
            candidate: {
              candidate: e.candidate.candidate,
              sdpMLineIndex: e.candidate.sdpMLineIndex,
              sdpMid: e.candidate.sdpMid
            }, 
            target: viewerId 
          });
        }
      };

      pc.oniceconnectionstatechange = () => {
        log("üîó ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: " + pc.iceConnectionState);
        if (pc.iceConnectionState === 'connected') {
          statusDiv.innerHTML = '<span class="connected">‚úÖ –í–∏–¥–µ–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∑—Ä–∏—Ç–µ–ª—é</span>';
        } else if (pc.iceConnectionState === 'failed') {
          log("‚ùå ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å");
        } else if (pc.iceConnectionState === 'disconnected') {
          log("‚ö†Ô∏è ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ");
        }
      };

      pc.onconnectionstatechange = () => {
        log("üîó Connection —Å–æ—Å—Ç–æ—è–Ω–∏–µ: " + pc.connectionState);
      };

      pc.onicegatheringstatechange = () => {
        log("üßä ICE gathering —Å–æ—Å—Ç–æ—è–Ω–∏–µ: " + pc.iceGatheringState);
      };

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è offer
      peerConnections[viewerId] = pc;
      iceCandidatesQueues[viewerId] = []; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—á–µ—Ä–µ–¥—å –¥–ª—è —ç—Ç–æ–≥–æ –∑—Ä–∏—Ç–µ–ª—è

      // –°–æ–∑–¥–∞—ë–º offer
      try {
        log("üîÑ –°–æ–∑–¥–∞—é offer –¥–ª—è –∑—Ä–∏—Ç–µ–ª—è " + viewerId);
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        // –ö–†–ò–¢–ò–ß–ù–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ offer —Å–æ–∑–¥–∞–Ω
        if (!offer || !offer.sdp) {
          log("‚ùå –û–®–ò–ë–ö–ê: offer –ø—É—Å—Ç–æ–π!");
          return;
        }

        log("‚úÖ Offer —Å–æ–∑–¥–∞–Ω, –¥–ª–∏–Ω–∞ SDP: " + offer.sdp.length);
        log("üì° –û—Ç–ø—Ä–∞–≤–ª—è—é offer –∑—Ä–∏—Ç–µ–ª—é " + viewerId);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º –≤—Å–µ—Ö –ø–æ–ª–µ–π
        const offerData = { 
          offer: { 
            type: offer.type, 
            sdp: offer.sdp 
          }, 
          target: viewerId 
        };
        
        log("üì§ –î–∞–Ω–Ω—ã–µ offer: " + JSON.stringify({type: offer.type, sdpLength: offer.sdp.length}));
        socket.emit("offer", offerData);
        log("‚úÖ –°–æ–±—ã—Ç–∏–µ offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");

      } catch (err) {
        log("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: " + err.message);
        console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer:", err);
      }
    });

    // –ü–æ–ª—É—á–∞–µ–º answer –æ—Ç –∑—Ä–∏—Ç–µ–ª—è
    socket.on("answer", async ({ answer, target }) => {
      log("üì• Answer –ø–æ–ª—É—á–µ–Ω, target: " + target);
      const pc = peerConnections[target];
      if (!pc) {
        log("‚ùå PeerConnection –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è " + target);
        return;
      }
      if (!answer) {
        log("‚ùå Answer –ø—É—Å—Ç–æ–π!");
        return;
      }
      try {
        log("üîÑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é answer, —Ç–∏–ø: " + answer.type);
        await pc.setRemoteDescription(new RTCSessionDescription({
          type: answer.type,
          sdp: answer.sdp
        }));
        log("‚úÖ Answer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ");

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ ICE candidates
        const queue = iceCandidatesQueues[target];
        if (queue && queue.length > 0) {
          log(`üì¶ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é ${queue.length} –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö ICE candidates –¥–ª—è ${target}`);
          for (const candidate of queue) {
            try {
              await pc.addIceCandidate(new RTCIceCandidate(candidate));
              log("‚úÖ –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π ICE candidate –¥–æ–±–∞–≤–ª–µ–Ω");
            } catch (err) {
              log("‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–≥–æ ICE: " + err.message);
            }
          }
          iceCandidatesQueues[target] = [];
        }
      } catch (err) {
        log("‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ answer: " + err.message);
        console.error("–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ answer:", err);
      }
    });

    // –ü–æ–ª—É—á–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –æ—Ç –∑—Ä–∏—Ç–µ–ª—è
    socket.on("ice-candidate", async ({ candidate, target }) => {
      log("üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –ø–æ–ª—É—á–µ–Ω –æ—Ç –∑—Ä–∏—Ç–µ–ª—è " + target);
      const pc = peerConnections[target];
      
      if (!candidate) {
        log("‚ùå candidate –ø—É—Å—Ç–æ–π");
        return;
      }

      if (!pc) {
        log("‚ùå PeerConnection –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è " + target);
        return;
      }

      // –ï—Å–ª–∏ remote description –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
      if (!pc.remoteDescription) {
        log("üì¶ Remote description –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –¥–æ–±–∞–≤–ª—è—é –≤ –æ—á–µ—Ä–µ–¥—å");
        if (!iceCandidatesQueues[target]) {
          iceCandidatesQueues[target] = [];
        }
        iceCandidatesQueues[target].push(candidate);
        return;
      }

      // –ò–Ω–∞—á–µ —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º
      try {
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
        log("‚úÖ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω");
      } catch (err) {
        log("‚ùå –û—à–∏–±–∫–∞ ICE: " + err.message);
        console.error("–û—à–∏–±–∫–∞ ICE:", err);
      }
    });

    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É, –µ—Å–ª–∏ –∑—Ä–∏—Ç–µ–ª–µ–π –Ω–µ—Ç
    socket.on("camera-stop", () => {
      log("üõë –ó—Ä–∏—Ç–µ–ª–µ–π –Ω–µ—Ç ‚Äî –∫–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è");
      statusDiv.innerHTML = '<span class="disconnected">‚è∏ –ù–µ—Ç –∑—Ä–∏—Ç–µ–ª–µ–π</span>';
      
      for (const id in peerConnections) {
        peerConnections[id].close();
        delete peerConnections[id];
        delete iceCandidatesQueues[id];
      }
      
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        video.srcObject = null;
      }
      
      // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º Wake Lock
      if (wakeLock !== null) {
        wakeLock.release();
        wakeLock = null;
      }
    });

    socket.on("error", (error) => {
      log("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∫–µ—Ç–∞: " + JSON.stringify(error));
      console.error("Socket error:", error);
    });

    // –û—Ç–ª–∞–¥–∫–∞: —Å–ª—É—à–∞–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è
    socket.onAny((eventName, ...args) => {
      log("üì® –°–æ–±—ã—Ç–∏–µ –ø–æ–ª—É—á–µ–Ω–æ: " + eventName);
    });

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => log("‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω"))
        .catch(err => log("‚ùå –û—à–∏–±–∫–∞ Service Worker: " + err.message));
    }
  </script>
</body>
</html>