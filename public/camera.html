<!-- camera.html: исправления -->
<!--
  - Сохраняется deviceId камеры через localStorage, восстанавливает пару и автоматом показывает код если нет пары
  - Включение камеры — авто при появлении зрителя, остановка — авто при уходе зрителя
  - Передача аудио обратно, звук выводится на камере от зрителя
  - Кнопка разрыва пары внизу с confirm
-->

<html>
<head>
  <title>Камера видеонаблюдения</title>
  <meta charset="UTF-8">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    #breakPairBtn {
      position: fixed;
      left: 0; bottom: 0;
      width: 100vw; height: 60px;
      background: #aa1f1f; color:#fff; border:none; font-size: 20px;
    }
  </style>
</head>
<body>
<div id="status"></div>
<div id="pairInfo"></div>
<div id="codeArea"></div>
<video id="cameraVideo" autoplay muted playsinline></video>
<audio id="remoteAudio" controls style="display:none"></audio>

<button id="breakPairBtn" style="display:none">Разорвать пару</button>
<script>
const role = "camera";
let deviceId = localStorage.getItem('cameraDeviceId');
if (!deviceId) {
  deviceId = 'cam-' + Math.random().toString(36).substr(2, 10);
  localStorage.setItem('cameraDeviceId', deviceId);
}
const socket = io();
socket.emit('register-device', { deviceId, role });

let pairedWith = null;
function showStatus(msg) { document.getElementById('status').innerText = msg; }

socket.on('pair-exists', ({pairedWith:pw, partnerOnline}) => {
  pairedWith = pw;
  showStatus('Сохранена пара: ' + pw + (partnerOnline ? ' (онлайн)' : ' (офлайн)'));
  document.getElementById('codeArea').innerText = '';
  document.getElementById('breakPairBtn').style.display = 'block';
});

socket.on('no-pair', () => { 
  document.getElementById('breakPairBtn').style.display = 'none';
  pairedWith = null; showStatus('Пары нет.'); document.getElementById('codeArea').innerHTML = '<button id="getCode">Получить код подключения</button>';
  document.getElementById('getCode').onclick = () => { socket.emit('generate-code', {deviceId}); showStatus('Генерируем код...'); };
});

socket.on('code-generated', ({code,expiresAt}) => {
  document.getElementById('codeArea').innerText = 'Код для зрителя: ' + code + ' (действителен 5 минут)';
});
socket.on('code-expired', () => { document.getElementById('codeArea').innerText = 'Код истек. Получите новый'; });

socket.on('paired', ({pairedWith:pw,role}) => {
  pairedWith = pw; showStatus('Связано со зрителем: ' + pw);
  document.getElementById('breakPairBtn').style.display = 'block';
  document.getElementById('codeArea').innerText = '';
});

document.getElementById('breakPairBtn').onclick = () => {
  if (confirm('Вы уверены? Разорвать пару?')) {
    socket.emit('break-pair', {deviceId});
  }
};

socket.on('pair-broken', () => { pairedWith = null; showStatus('Пара разорвана'); document.getElementById('breakPairBtn').style.display = 'none'; });

// Автовключение/выключение камеры
socket.on('start-camera-request', () => { startCamera(); });
socket.on('stop-camera-request', () => { stopCamera(); });

// Инициализация WebRTC
let pc, localStream;
async function startCamera() {
  showStatus('Включаем камеру...');
  localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
  document.getElementById('cameraVideo').srcObject = localStream;
  createPeerConnection();
}
function stopCamera() {
  if(localStream) { localStream.getTracks().forEach(t=>t.stop()); }
  if(pc) pc.close();
  document.getElementById('cameraVideo').srcObject = null;
  showStatus('Камера выключена');
}
async function createPeerConnection() {
  pc = new RTCPeerConnection();
  localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));
  pc.onicecandidate = e => { if(e.candidate) socket.emit('ice-candidate',{candidate:e.candidate,targetDeviceId:pairedWith}); };
  pc.ontrack = ev => {
    // поток с аудио зрителя (обратная связь)
    if(ev.track.kind==="audio") {
      const audio = document.getElementById('remoteAudio');
      audio.srcObject = ev.streams[0];
      audio.style.display='block';
      audio.play();
    }
  };
  const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
  socket.emit('offer', {offer, targetDeviceId:pairedWith});
}
socket.on('answer', async ({answer}) => { if(pc) await pc.setRemoteDescription(answer); });
socket.on('ice-candidate', async ({candidate}) => { if(pc) await pc.addIceCandidate(new RTCIceCandidate(candidate)); });

// auto start after pair restored
document.addEventListener('DOMContentLoaded',()=>{
  if(pairedWith) startCamera();
});
</script>
</body>
</html>
