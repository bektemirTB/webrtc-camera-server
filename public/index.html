<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞–º–µ—Ä–∞</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #1a1a1a;
      color: white;
    }
    video {
      width: 100%;
      max-width: 640px;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      background: black;
    }
    .status {
      margin: 10px 0;
      padding: 10px;
      background: #333;
      border-radius: 5px;
    }
    .connected { color: #4CAF50; }
    .disconnected { color: #f44336; }
  </style>
</head>
<body>
  <h1>üìπ –ö–∞–º–µ—Ä–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è</h1>
  <div class="status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
  <video id="localVideo" autoplay playsinline muted></video>
  <div id="log"></div>

  <script>
    const socket = io("https://webrtc-camera-server.onrender.com");
    const roomId = "room1";
    const video = document.getElementById("localVideo");
    const statusDiv = document.getElementById("status");
    const logDiv = document.getElementById("log");
    let stream;
    const peerConnections = {};

    function log(msg) {
      console.log(msg);
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML = `<div style="color: #888; font-size: 12px;">[${time}] ${msg}</div>` + logDiv.innerHTML;
    }

    socket.on("connect", () => {
      log("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É");
      statusDiv.innerHTML = '<span class="connected">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É</span>';
      socket.emit("join-room", { roomId, role: "camera" });
      log("üì° –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ: " + roomId);
    });

    socket.on("disconnect", () => {
      log("‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
      statusDiv.innerHTML = '<span class="disconnected">‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞</span>';
    });

    // –ö–æ–≥–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤—ã–π –∑—Ä–∏—Ç–µ–ª—å
    socket.on("viewer-ready", async (viewerId) => {
      log("üëÅ –ó—Ä–∏—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è: " + viewerId);
      statusDiv.innerHTML = '<span class="connected">üëÅ –ó—Ä–∏—Ç–µ–ª—å —Å–º–æ—Ç—Ä–∏—Ç</span>';

      // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
      if (!stream) {
        try {
          log("üì∑ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...");
          stream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: 1280, height: 720 }, 
            audio: false 
          });
          video.srcObject = stream;
          log("‚úÖ –ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
        } catch (err) {
          log("‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: " + err.message);
          console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
          return;
        }
      }

      // –°–æ–∑–¥–∞—ë–º PeerConnection –¥–ª—è —ç—Ç–æ–≥–æ –∑—Ä–∏—Ç–µ–ª—è
      const pc = new RTCPeerConnection({
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      });

      // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏
      stream.getTracks().forEach(track => {
        pc.addTrack(track, stream);
        log("‚ûï –¢—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω: " + track.kind);
      });

      // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
      pc.onicecandidate = e => {
        if (e.candidate) {
          log("üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑—Ä–∏—Ç–µ–ª—é");
          socket.emit("ice-candidate", { 
            candidate: {
              candidate: e.candidate.candidate,
              sdpMLineIndex: e.candidate.sdpMLineIndex,
              sdpMid: e.candidate.sdpMid
            }, 
            target: viewerId 
          });
        }
      };

      pc.oniceconnectionstatechange = () => {
        log("üîó ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: " + pc.iceConnectionState);
        if (pc.iceConnectionState === 'connected') {
          statusDiv.innerHTML = '<span class="connected">‚úÖ –í–∏–¥–µ–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∑—Ä–∏—Ç–µ–ª—é</span>';
        }
      };

      // –°–æ–∑–¥–∞—ë–º offer
      try {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        log("üì° Offer —Å–æ–∑–¥–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑—Ä–∏—Ç–µ–ª—é");
        socket.emit("offer", { 
          offer: { 
            type: offer.type, 
            sdp: offer.sdp 
          }, 
          target: viewerId 
        });

        peerConnections[viewerId] = pc;
      } catch (err) {
        log("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: " + err.message);
        console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer:", err);
      }
    });

    // –ü–æ–ª—É—á–∞–µ–º answer –æ—Ç –∑—Ä–∏—Ç–µ–ª—è
    socket.on("answer", async ({ answer, target }) => {
      log("üì• Answer –ø–æ–ª—É—á–µ–Ω –æ—Ç –∑—Ä–∏—Ç–µ–ª—è");
      const pc = peerConnections[target];
      if (pc && answer) {
        try {
          await pc.setRemoteDescription(new RTCSessionDescription({
            type: answer.type,
            sdp: answer.sdp
          }));
          log("‚úÖ Answer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
        } catch (err) {
          log("‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ answer: " + err.message);
          console.error("–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ answer:", err);
        }
      }
    });

    // –ü–æ–ª—É—á–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –æ—Ç –∑—Ä–∏—Ç–µ–ª—è
    socket.on("ice-candidate", async ({ candidate, target }) => {
      log("üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –ø–æ–ª—É—á–µ–Ω –æ—Ç –∑—Ä–∏—Ç–µ–ª—è");
      const pc = peerConnections[target];
      if (pc && candidate) {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(candidate));
          log("‚úÖ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω");
        } catch (err) {
          log("‚ùå –û—à–∏–±–∫–∞ ICE: " + err.message);
          console.error("–û—à–∏–±–∫–∞ ICE:", err);
        }
      }
    });

    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É, –µ—Å–ª–∏ –∑—Ä–∏—Ç–µ–ª–µ–π –Ω–µ—Ç
    socket.on("camera-stop", () => {
      log("üõë –ó—Ä–∏—Ç–µ–ª–µ–π –Ω–µ—Ç ‚Äî –∫–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è");
      statusDiv.innerHTML = '<span class="disconnected">‚è∏ –ù–µ—Ç –∑—Ä–∏—Ç–µ–ª–µ–π</span>';
      
      for (const id in peerConnections) {
        peerConnections[id].close();
        delete peerConnections[id];
      }
      
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        video.srcObject = null;
      }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–æ–∫–µ—Ç–∞
    socket.on("error", (error) => {
      log("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∫–µ—Ç–∞: " + error);
      console.error("Socket error:", error);
    });
  </script>
</body>
</html>